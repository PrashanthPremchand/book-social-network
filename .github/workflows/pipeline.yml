name: BSN Backend API Pipeline

on:
  push:
    branches:
      - master
    paths:
      - book-network/**
      - Dockerfile
      - 'docker-compose.yml'
      - .github/workflows/pipeline.yml

jobs:
  compile:
    runs-on: ubuntu-latest
    name: Compile project
    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'corretto'

      - name: Compile project
        run: |
          cd book-network
          mvn clean compile

  

  unit-tests:
    runs-on: ubuntu-latest
    name: Unit tests
    needs: [compile]
    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'corretto'

      - name: Running unit tests
        run: |
          cd book-network
          mvn clean test


  build-and-push:
    runs-on: ubuntu-latest
    needs: [compile, unit-tests]
    timeout-minutes: 30
    outputs:
      project_version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Extract project version
        id: extract_version
        run: |
          cd book-network
          # Using quotes and tr to ensure a clean string
          VERSION=$(mvn help:evaluate -Dexpression="project.version" -q -DforceStdout --non-recursive | tr -d '\r\n[:space:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build JAR
        run: |
          cd book-network
          mvn clean package -DskipTests

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push to DockerHub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          # Fixed the tag syntax and variable casing
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/bsn-api:${{ steps.extract_version.outputs.version }}
            ${{ secrets.DOCKER_USERNAME }}/bsn-api:latest
          build-args: |
            PROFILE=dev
            APP_VERSION=${{ steps.extract_version.outputs.version }}
          





  deploy:
    name: Deploy Backend
    runs-on: self-hosted
    needs: [ build-and-push ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment folder (Windows)
        shell: powershell
        run: |
          $deployPath = "$env:USERPROFILE\ci-cd"
          New-Item -ItemType Directory -Path $deployPath -Force

      - name: Copy docker-compose file (Windows)
        shell: powershell
        run: |
          $deployPath = "$env:USERPROFILE\ci-cd"
          Copy-Item "docker-compose.yml" -Destination "$deployPath\docker-compose.yml" -Force

      - name: Deploy containers (Windows)
        shell: powershell
        env:
          # Docker
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          APP_VERSION: ${{ needs.build-and-push.outputs.project_version }}

          # Spring
          SPRING_PROFILES_ACTIVE: dev
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

          # Mail
          EMAIL_HOST_NAME: ${{ secrets.EMAIL_HOST_NAME }}
          EMAIL_USER_NAME: ${{ secrets.EMAIL_USER_NAME }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

        run: |
          $deployPath = "$env:USERPROFILE\ci-cd"
          Set-Location $deployPath

          docker compose down --remove-orphans
          docker compose pull
          docker compose up -d
  




